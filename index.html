<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bajaj Task Management Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; 
            --light: #f8f9fa; --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f; 
        }
        
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--light); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        
        h2 { color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        .card { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        
        input, select, button { padding: 12px; margin: 8px 0; width: 100%; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        
        .logout { background: var(--danger); width: auto; float: right; padding: 6px 12px; font-size: 13px; margin-bottom: 10px; }
        
        .flex-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .stat-box { flex: 1; min-width: 100px; padding: 15px; border-radius: 10px; color: white; text-align: center; cursor: pointer; transition: transform 0.2s; }
        .stat-box b { font-size: 24px; display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }

        .status-tag { padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; }
        .Initial { background: #bdc3c7; color: #333; }
        .In-Process { background: var(--warning); color: #333; }
        .Completed { background: var(--success); color: white; }
        
        .group-badge { background: #9b59b6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; display: inline-block; margin-bottom: 4px;}
        .leader-badge { background: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; display: inline-block; margin-bottom: 4px;}
        select[multiple] { height: 100px; }
        .btn-del { background: var(--danger); width: auto; padding: 5px 10px; font-size: 11px; margin-left: 5px;}
    </style>
</head>
<body>

<div class="container">
    <div id="login-section">
        <h2 style="text-align:center; border:none;">BAJAJ TASK SYSTEM</h2>
        <div class="card" style="max-width: 400px; margin: auto; border-top: 5px solid var(--accent);">
            <input type="text" id="login-id" placeholder="Admin or Employee Code">
            <button onclick="handleLogin()">Access Dashboard</button>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <button class="logout" onclick="logout()">Logout</button>
        <h2>Admin Management</h2>
        
        <div class="card">
            <div class="flex-row">
                <div class="stat-box" onclick="setFilter('Initial')" style="background: #7f8c8d;"><small>Initial</small><b id="stat-initial">0</b></div>
                <div class="stat-box" onclick="setFilter('In-Process')" style="background: var(--warning); color: #333;"><small>In-Process</small><b id="stat-progress">0</b></div>
                <div class="stat-box" onclick="setFilter('Completed')" style="background: var(--success);"><small>Completed</small><b id="stat-completed">0</b></div>
            </div>
        </div>

        <div class="flex-row">
            <div class="card" style="flex: 1; min-width: 250px; border-top: 4px solid var(--primary);">
                <h3>Staff Registration</h3>
                <input type="text" id="reg-name" placeholder="Full Name">
                <input type="text" id="reg-code" placeholder="Employee Code">
                <input type="text" id="reg-desig" placeholder="Designation">
                <input type="tel" id="reg-phone" placeholder="Phone Number">
                <button onclick="saveEmployee()">Register Staff</button>
            </div>

            <div class="card" style="flex: 1; min-width: 250px; border-top: 4px solid #9b59b6;">
                <h3>Make Group & Assign</h3>
                <input type="text" id="group-name-input" placeholder="Enter Group Name">
                <p style="font-size:11px; color:#666; margin:0;">Select Group Leader:</p>
                <select id="group-leader-select"></select>
                <p style="font-size:11px; color:#666; margin:0;">Select Members (Hold Ctrl/Cmd):</p>
                <select id="group-members-select" multiple></select>
                <input type="text" id="group-task-name" placeholder="Task for the Group">
                <button onclick="assignGroupTask()" style="background: #9b59b6;">Assign to Group</button>
            </div>

            <div class="card" style="flex: 1; min-width: 250px; border-top: 4px solid var(--accent);">
                <h3>Assign Single Task</h3>
                <select id="task-assignee"></select>
                <input type="text" id="task-name" placeholder="Task Details">
                <button onclick="assignTask()" style="background: var(--success);">Assign Single</button>
            </div>
        </div>

        <h3>Monitoring Table</h3>
        <table>
            <thead>
                <tr>
                    <th>Staff/Group</th>
                    <th>Designation</th>
                    <th>Task Details</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="admin-list"></tbody>
        </table>
    </div>

    <div id="employee-dashboard" class="hidden">
        <button class="logout" onclick="logout()">Logout</button>
        <h2>Hi, <span id="display-emp-name"></span></h2>
        <div id="emp-task-cards"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAmQil4nkkdp98pAYCILemHxRTYCAy5nEw",
        authDomain: "taskmanager-45c3a.firebaseapp.com",
        databaseURL: "https://taskmanager-45c3a-default-rtdb.firebaseio.com",
        projectId: "taskmanager-45c3a",
        storageBucket: "taskmanager-45c3a.firebasestorage.app",
        messagingSenderId: "710242454866",
        appId: "1:710242454866:web:a87f396d484014f7c67e8b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentUser = null;
    let globalEmpData = {};
    let currentFilter = 'All';

    function handleLogin() {
        const id = document.getElementById('login-id').value.trim();
        if(['ADMIN00001', 'ASO-1', 'ASO-2'].includes(id)) {
            currentUser = { role: 'admin', id: id };
            showDashboard('admin');
        } else {
            db.ref('employees/' + id).once('value', snap => {
                if(snap.exists()) { 
                    currentUser = snap.val(); 
                    showDashboard('employee'); 
                } else { alert("User Code not found!"); }
            });
        }
    }

    function showDashboard(type) {
        document.getElementById('login-section').classList.add('hidden');
        if(type === 'admin') {
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadAdminData();
        } else {
            document.getElementById('employee-dashboard').classList.remove('hidden');
            document.getElementById('display-emp-name').innerText = currentUser.name;
            loadEmployeeTasks();
        }
    }

    function saveEmployee() {
        const n = document.getElementById('reg-name').value;
        const c = document.getElementById('reg-code').value;
        const d = document.getElementById('reg-desig').value;
        const p = document.getElementById('reg-phone').value;
        if(n && c) {
            db.ref('employees/' + c).set({ name: n, code: c, designation: d, phone: p });
            alert("Staff Registered!");
        }
    }

    function assignTask() {
        const c = document.getElementById('task-assignee').value;
        const t = document.getElementById('task-name').value;
        if(t) {
            db.ref('tasks/' + c).push({ taskName: t, status: 'Initial', date: new Date().toLocaleDateString() });
            alert("Single Task Assigned!");
        }
    }

    function assignGroupTask() {
        const gName = document.getElementById('group-name-input').value;
        const leader = document.getElementById('group-leader-select').value;
        const select = document.getElementById('group-members-select');
        const members = Array.from(select.selectedOptions).map(opt => opt.value);
        const taskName = document.getElementById('group-task-name').value;

        if (!gName || members.length < 1 || !taskName) return alert("Fill all fields, select leader and members");

        const groupKey = db.ref('group_tasks').push().key;
        db.ref('group_tasks/' + groupKey).set({
            groupName: gName,
            leader: leader,
            taskName: taskName,
            members: members,
            status: 'Initial',
            date: new Date().toLocaleDateString()
        }).then(() => {
            alert("Group Task Assigned!");
            document.getElementById('group-task-name').value = "";
            document.getElementById('group-name-input').value = "";
        });
    }

    function loadAdminData() {
        db.ref('employees').on('value', snap => {
            let opts = "";
            globalEmpData = snap.val() || {}; 
            snap.forEach(e => { opts += `<option value="${e.key}">${e.val().name} (${e.key})</option>`; });
            document.getElementById('task-assignee').innerHTML = opts;
            document.getElementById('group-leader-select').innerHTML = opts;
            document.getElementById('group-members-select').innerHTML = opts;
        });

        db.ref().on('value', snap => {
            let rows = "";
            let counts = { Initial: 0, 'In-Process': 0, Completed: 0 };
            const tasks = snap.child('tasks').val() || {};
            const groupTasks = snap.child('group_tasks').val() || {};

            Object.keys(tasks).forEach(empCode => {
                const staff = globalEmpData[empCode] || { name: empCode, designation: "N/A" };
                Object.keys(tasks[empCode]).forEach(tKey => {
                    const t = tasks[empCode][tKey];
                    counts[t.status]++;
                    if(currentFilter === 'All' || t.status === currentFilter) {
                        rows += `<tr>
                            <td><b>${staff.name}</b><br><small>${empCode}</small></td>
                            <td>${staff.designation || 'N/A'}</td>
                            <td>${t.taskName}</td>
                            <td><span class="status-tag ${t.status}">${t.status}</span></td>
                            <td><button class="btn-del" onclick="deleteTask('${empCode}','${tKey}','single')">Del</button></td>
                        </tr>`;
                    }
                });
            });

            Object.keys(groupTasks).forEach(gKey => {
                const gt = groupTasks[gKey];
                counts[gt.status]++;
                if(currentFilter === 'All' || gt.status === currentFilter) {
                    const leaderName = globalEmpData[gt.leader]?.name || gt.leader;
                    const memberNames = gt.members.map(m => globalEmpData[m]?.name || m).join(", ");
                    rows += `<tr style="background:#f9f1ff">
                        <td><span class="group-badge">${gt.groupName || 'GROUP'}</span><br><small>${memberNames}</small></td>
                        <td><span class="leader-badge">LEADER: ${leaderName}</span></td>
                        <td>${gt.taskName}</td>
                        <td><span class="status-tag ${gt.status}">${gt.status}</span></td>
                        <td><button class="btn-del" onclick="deleteTask(null,'${gKey}','group')">Del</button></td>
                    </tr>`;
                }
            });

            document.getElementById('admin-list').innerHTML = rows;
            document.getElementById('stat-initial').innerText = counts.Initial;
            document.getElementById('stat-progress').innerText = counts['In-Process'];
            document.getElementById('stat-completed').innerText = counts.Completed;
        });
    }

    function loadEmployeeTasks() {
        const empCode = currentUser.code;
        db.ref().on('value', snap => {
            let html = "";
            const tasks = snap.child('tasks/' + empCode).val() || {};
            const groupTasks = snap.child('group_tasks').val() || {};

            Object.keys(tasks).forEach(tid => {
                html += createTaskCard(tasks[tid].taskName, tasks[tid].status, tid, 'single');
            });

            Object.keys(groupTasks).forEach(gid => {
                if(groupTasks[gid].members.includes(empCode)) {
                    const gName = groupTasks[gid].groupName || "Group Task";
                    html += createTaskCard(`${gName}: ${groupTasks[gid].taskName}`, groupTasks[gid].status, gid, 'group');
                }
            });
            document.getElementById('emp-task-cards').innerHTML = html || "No tasks.";
        });
    }

    function createTaskCard(name, status, id, type) {
        return `<div class="card" style="border-left:5px solid ${type === 'group' ? '#9b59b6' : '#3498db'}">
            ${type === 'group' ? '<span class="group-badge">GROUP TASK</span>' : ''}
            <p><b>${name}</b></p>
            <select id="sel-${id}">
                <option value="Initial" ${status=='Initial'?'selected':''}>Initial</option>
                <option value="In-Process" ${status=='In-Process'?'selected':''}>In-Process</option>
                <option value="Completed" ${status=='Completed'?'selected':''}>Completed</option>
            </select>
            <button onclick="updateStatus('${id}', '${type}')" style="background:var(--success)">Update Status</button>
        </div>`;
    }

    function updateStatus(id, type) {
        const val = document.getElementById('sel-'+id).value;
        const path = type === 'single' ? `tasks/${currentUser.code}/${id}` : `group_tasks/${id}`;
        db.ref(path).update({ status: val }).then(() => alert("Status Updated!"));
    }

    function deleteTask(empCode, tKey, type) {
        if(!confirm("Delete?")) return;
        const path = type === 'single' ? `tasks/${empCode}/${tKey}` : `group_tasks/${tKey}`;
        db.ref(path).remove();
    }

    function logout() { location.reload(); }
    function setFilter(s) { currentFilter = s; loadAdminData(); }
</script>
</body>
</html>
