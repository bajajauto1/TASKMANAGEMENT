<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management System Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; 
            --secondary: #34495e; 
            --accent: #3498db; 
            --light: #f4f7f6; 
            --success: #27ae60; 
            --danger: #e74c3c; 
            --warning: #f1c40f; 
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--light); 
            margin: 0; 
            padding: 0; 
            color: #333;
        }

        .container { 
            max-width: 100%; 
            margin: auto; 
            padding: 15px; 
            box-sizing: border-box;
        }

        .hidden { display: none !important; }

        /* Typography */
        h2 { color: var(--primary); font-size: 1.5rem; margin-bottom: 20px; text-align: center; }
        h3 { font-size: 1.1rem; margin-top: 0; }

        /* Cards */
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        /* Forms */
        input, select, button { 
            padding: 14px; 
            margin: 8px 0; 
            width: 100%; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; /* Prevents iOS zoom on focus */
            box-sizing: border-box; 
            display: block;
        }

        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            transition: background 0.3s;
        }

        button:active { transform: scale(0.98); }

        .logout { 
            background: var(--danger); 
            width: auto; 
            padding: 8px 15px; 
            font-size: 14px;
            float: right;
            margin-top: -50px;
        }

        /* Dashboard Stats */
        .flex-row { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-bottom: 15px; 
        }

        .stat-box { 
            padding: 12px 5px; 
            border-radius: 8px; 
            color: white; 
            text-align: center; 
        }
        .stat-box small { font-size: 10px; display: block; margin-bottom: 5px; }
        .stat-box b { font-size: 20px; }

        /* Responsive Table Replacement */
        .task-list-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }

        /* Table view for Desktop, List view for Mobile */
        @media (max-width: 768px) {
            table thead { display: none; }
            table, tbody, tr, td { display: block; width: 100%; }
            tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; padding: 10px; }
            td { text-align: right; padding-left: 50%; position: relative; border: none; border-bottom: 1px solid #eee; }
            td::before { content: attr(data-label); position: absolute; left: 10px; width: 45%; font-weight: bold; text-align: left; }
            .flex-row { grid-template-columns: 1fr; }
            .logout { float: none; width: 100%; margin-top: 0; margin-bottom: 20px; }
        }

        @media (min-width: 769px) {
            .container { max-width: 900px; padding: 40px 20px; }
            .flex-row-admin { display: flex; gap: 20px; }
            .flex-row-admin .card { flex: 1; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
            th { background: var(--primary); color: white; }
        }

        .status-tag { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 11px; 
            font-weight: bold; 
        }
        .Initial { background: #eee; color: #666; }
        .In-Process { background: var(--warning); color: #000; }
        .Completed { background: var(--success); color: #fff; }

        .progress-container { width: 100%; background: #eee; border-radius: 10px; height: 10px; overflow: hidden; display: flex; margin: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-section">
        <h2>BAJAJ TASK SYSTEM</h2>
        <div class="card" style="border-top: 5px solid var(--accent);">
            <input type="text" id="login-id" placeholder="ADMIN, ASO-1, ASO-2 or Emp Code">
            <button onclick="handleLogin()">Access Dashboard</button>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <button class="logout" onclick="logout()">Logout</button>
        <h2>Admin Panel</h2>
        
        <div class="card">
            <h3>üìä Live Team Report</h3>
            <div class="flex-row">
                <div class="stat-box" style="background: #95a5a6;"><small>INITIAL</small><b id="stat-initial">0</b></div>
                <div class="stat-box" style="background: var(--warning); color: #333;"><small>IN-PROGRESS</small><b id="stat-progress">0</b></div>
                <div class="stat-box" style="background: var(--success);"><small>COMPLETED</small><b id="stat-completed">0</b></div>
            </div>
            <div class="progress-container">
                <div id="bar-initial" style="background: #bdc3c7; width: 0%;"></div>
                <div id="bar-progress" style="background: var(--warning); width: 0%;"></div>
                <div id="bar-completed" style="background: var(--success); width: 0%;"></div>
            </div>
            <p id="completion-text" style="text-align: center; font-size: 13px; margin: 0;">0% Completion Rate</p>
        </div>

        <div class="flex-row-admin">
            <div class="card">
                <h3>User Management</h3>
                <input type="text" id="emp-name" placeholder="Full Name">
                <input type="text" id="emp-code" placeholder="Login Code">
                <input type="text" id="emp-designation" placeholder="Designation">
                <button onclick="saveEmployee()">Save Employee</button>
            </div>
            <div class="card">
                <h3>Assign Task</h3>
                <select id="task-assignee"></select>
                <input type="text" id="task-name" placeholder="Task details...">
                <button onclick="assignTask()" style="background: var(--success);">Assign Now</button>
            </div>
        </div>
        
        <button onclick="exportCSV()" style="background: var(--secondary);">‚¨áÔ∏è Download CSV Report</button>

        <h3>Monitoring</h3>
        <table id="admin-table">
            <thead>
                <tr>
                    <th>Staff</th>
                    <th>Task</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="admin-list"></tbody>
        </table>
    </div>

    <div id="employee-dashboard" class="hidden">
        <button class="logout" onclick="logout()">Logout</button>
        <h2 style="text-align:left">Hi, <span id="display-emp-name"></span></h2>
        <div class="card">
            <h3 style="border-bottom: 1px solid #eee; padding-bottom:10px">My Active Tasks</h3>
            <div id="emp-list-mobile">
                </div>
            <table id="emp-table" class="hidden"> <tbody id="emp-list"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Config stays the same as your original
    const firebaseConfig = {
        apiKey: "AIzaSyAmQil4nkkdp98pAYCILemHxRTYCAy5nEw",
        authDomain: "taskmanager-45c3a.firebaseapp.com",
        databaseURL: "https://taskmanager-45c3a-default-rtdb.firebaseio.com",
        projectId: "taskmanager-45c3a",
        storageBucket: "taskmanager-45c3a.firebasestorage.app",
        messagingSenderId: "710242454866",
        appId: "1:710242454866:web:a87f396d484014f7c67e8b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = null;
    let globalEmpData = {};

    function handleLogin() {
        const id = document.getElementById('login-id').value.trim();
        if(!id) return alert("Please enter a code");
        
        if(id === 'ADMIN00001' || id === 'ASO-1' || id === 'ASO-2') {
            currentUser = { role: 'admin', id: id };
            showDashboard('admin');
        } else {
            db.ref('employees/' + id).once('value', snap => {
                if(snap.exists()) { 
                    currentUser = snap.val(); 
                    showDashboard('employee'); 
                }
                else { alert("User not found."); }
            });
        }
    }

    function showDashboard(type) {
        document.getElementById('login-section').classList.add('hidden');
        if(type === 'admin') {
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadAdminData();
        } else {
            document.getElementById('employee-dashboard').classList.remove('hidden');
            document.getElementById('display-emp-name').innerText = currentUser.name;
            loadEmployeeTasks();
        }
    }

    function saveEmployee() {
        const name = document.getElementById('emp-name').value;
        const code = document.getElementById('emp-code').value;
        const designation = document.getElementById('emp-designation').value;
        if(name && code) {
            db.ref('employees/' + code).set({ name, code, designation })
            .then(() => {
                alert("Employee Updated!");
                document.getElementById('emp-name').value = '';
                document.getElementById('emp-code').value = '';
            });
        }
    }

    function assignTask() {
        const code = document.getElementById('task-assignee').value;
        const task = document.getElementById('task-name').value;
        if(task) {
            db.ref('tasks/' + code).push({ 
                taskName: task, 
                status: 'Initial', 
                date: new Date().toLocaleDateString() 
            });
            document.getElementById('task-name').value = "";
            alert("Task Assigned!");
        }
    }

    function loadAdminData() {
        db.ref('employees').on('value', snap => {
            let opts = "";
            globalEmpData = snap.val() || {}; 
            snap.forEach(e => {
                opts += `<option value="${e.key}">${e.val().name}</option>`;
            });
            document.getElementById('task-assignee').innerHTML = opts;
        });

        db.ref('tasks').on('value', snap => {
            let rows = ""; let i = 0, p = 0, c = 0, total = 0;
            snap.forEach(empTasks => {
                const details = globalEmpData[empTasks.key] || { name: "N/A" };
                empTasks.forEach(tSnap => {
                    const t = tSnap.val(); total++;
                    if(t.status==='Initial') i++; else if(t.status==='In-Process') p++; else c++;
                    rows += `<tr>
                        <td data-label="Staff"><b>${details.name}</b><br><small>${empTasks.key}</small></td>
                        <td data-label="Task">${t.taskName}</td>
                        <td data-label="Status"><span class="status-tag ${t.status}">${t.status}</span></td>
                        <td data-label="Action"><button style="background:var(--danger); font-size:12px; padding:5px;" onclick="deleteTask('${empTasks.key}','${tSnap.key}')">Delete</button></td>
                    </tr>`;
                });
            });
            document.getElementById('admin-list').innerHTML = rows || "<tr><td colspan='4'>No tasks found</td></tr>";
            updateStats(i, p, c, total);
        });
    }

    function updateStats(i, p, c, total) {
        document.getElementById('stat-initial').innerText = i;
        document.getElementById('stat-progress').innerText = p;
        document.getElementById('stat-completed').innerText = c;
        if(total > 0) {
            const perc = Math.round(c/total*100);
            document.getElementById('bar-initial').style.width = (i/total*100) + "%";
            document.getElementById('bar-progress').style.width = (p/total*100) + "%";
            document.getElementById('bar-completed').style.width = (c/total*100) + "%";
            document.getElementById('completion-text').innerText = perc + "% Completion (" + total + " total)";
        }
    }

    function loadEmployeeTasks() {
        db.ref('tasks/' + currentUser.code).on('value', snap => {
            let html = "";
            snap.forEach(tSnap => {
                const t = tSnap.val(); const tid = tSnap.key;
                html += `
                <div class="task-list-item">
                    <div style="margin-bottom:10px"><strong>${t.taskName}</strong></div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select id="sel-${tid}" style="margin:0; flex:2;">
                            <option value="Initial" ${t.status=='Initial'?'selected':''}>Initial</option>
                            <option value="In-Process" ${t.status=='In-Process'?'selected':''}>In-Process</option>
                            <option value="Completed" ${t.status=='Completed'?'selected':''}>Completed</option>
                        </select>
                        <button onclick="submitStatus('${tid}')" style="margin:0; flex:1; background: var(--success); font-size:12px;">UPDATE</button>
                    </div>
                </div>`;
            });
            document.getElementById('emp-list-mobile').innerHTML = html || "<p>No tasks assigned to you yet.</p>";
        });
    }

    function submitStatus(tid) {
        const s = document.getElementById('sel-' + tid).value;
        db.ref('tasks/' + currentUser.code + '/' + tid).update({ status: s })
        .then(() => alert("Status Updated!"));
    }

    function deleteTask(eid, tid) { if(confirm("Delete this task?")) db.ref(`tasks/${eid}/${tid}`).remove(); }
    
    function exportCSV() {
        db.ref('tasks').once('value', taskSnap => {
            let csv = "Code,Name,Task,Status,Date\n";
            taskSnap.forEach(empTasks => {
                const info = globalEmpData[empTasks.key] || { name: "N/A" };
                empTasks.forEach(t => {
                    const data = t.val();
                    csv += `${empTasks.key},${info.name},${data.taskName},${data.status},${data.date}\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Report.csv';
            link.click();
        });
    }
    function logout() { location.reload(); }
</script>
</body>
</html>
