<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bajaj Task Management Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; 
            --light: #f8f9fa; --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f; 
        }
        
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--light); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .hidden { display: none !important; }
        
        h2 { color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 10px; margin-top: 0; }
        .card { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        
        input, select, button { padding: 12px; margin: 8px 0; width: 100%; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        
        .logout { background: var(--danger); width: auto; float: right; padding: 6px 12px; font-size: 13px; margin-bottom: 10px; }
        
        /* ANALYTICS BOXES */
        .flex-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .stat-box { 
            flex: 1; min-width: 100px; padding: 15px; border-radius: 10px; 
            color: white; text-align: center; cursor: pointer; 
            transition: transform 0.2s; 
        }
        .stat-box b { font-size: 24px; display: block; }

        /* MOBILE RESPONSIVE TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; }

        @media screen and (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ddd; margin-bottom: 15px; border-radius: 10px; background: #fff; padding: 5px; }
            td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 45% !important; text-align: right; }
            td:before { 
                position: absolute; left: 10px; width: 40%; font-weight: bold; 
                text-align: left; content: attr(data-label); color: var(--secondary);
            }
        }

        .status-tag { padding: 4px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; }
        .Initial { background: #bdc3c7; color: #333; }
        .In-Process { background: var(--warning); color: #333; }
        .Completed { background: var(--success); color: white; }
        
        .btn-call { background: #2ecc71; color: white; padding: 5px 10px; border-radius: 5px; text-decoration: none; font-size: 12px; display: inline-block; }
        .btn-del { background: var(--danger); width: auto; padding: 5px 10px; font-size: 11px; margin-left: 5px;}
    </style>
</head>
<body>

<div class="container">
    <div id="login-section">
        <h2 style="text-align:center; border:none;">BAJAJ TASK SYSTEM</h2>
        <div class="card" style="max-width: 400px; margin: auto; border-top: 5px solid var(--accent);">
            <input type="text" id="login-id" placeholder="Admin or Employee Code">
            <button onclick="handleLogin()">Access Dashboard</button>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <button class="logout" onclick="logout()">Logout</button>
        <h2>Admin Management</h2>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin:0">ðŸ“Š Analytical Filter</h3>
                <button onclick="setFilter('All')" style="width: auto; padding: 5px 12px; background: var(--secondary); font-size: 12px;">Reset View</button>
            </div>
            <div class="flex-row">
                <div class="stat-box" onclick="setFilter('Initial')" style="background: #7f8c8d;">
                    <small>Initial</small><b id="stat-initial">0</b>
                </div>
                <div class="stat-box" onclick="setFilter('In-Process')" style="background: var(--warning); color: #333;">
                    <small>In-Process</small><b id="stat-progress">0</b>
                </div>
                <div class="stat-box" onclick="setFilter('Completed')" style="background: var(--success);">
                    <small>Completed</small><b id="stat-completed">0</b>
                </div>
            </div>
        </div>

        <div class="flex-row">
            <div class="card" style="flex: 1; border-top: 4px solid var(--primary);">
                <h3>Staff Registration</h3>
                <input type="text" id="reg-name" placeholder="Full Name">
                <input type="text" id="reg-code" placeholder="Employee Code">
                <input type="text" id="reg-desig" placeholder="Designation (e.g. Sales)">
                <input type="tel" id="reg-phone" placeholder="Phone Number">
                <button onclick="saveEmployee()">Register Staff</button>
            </div>
            <div class="card" style="flex: 1; border-top: 4px solid var(--accent);">
                <h3>Assign New Task</h3>
                <select id="task-assignee"><option>Loading...</option></select>
                <input type="text" id="task-name" placeholder="Task Details">
                <button onclick="assignTask()" style="background: var(--success);">Assign Now</button>
            </div>
        </div>

        <button onclick="exportCSV()" style="background: #27ae60; margin-bottom: 20px;">ðŸ“¥ Download Detailed CSV</button>

        <h3>Monitoring Table</h3>
        <table id="admin-table">
            <thead>
                <tr>
                    <th>Staff Info</th>
                    <th>Designation</th>
                    <th>Task Details</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="admin-list"></tbody>
        </table>
    </div>

    <div id="employee-dashboard" class="hidden">
        <button class="logout" onclick="logout()">Logout</button>
        <h2>Hi, <span id="display-emp-name"></span></h2>
        <div id="emp-task-cards"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAmQil4nkkdp98pAYCILemHxRTYCAy5nEw",
        authDomain: "taskmanager-45c3a.firebaseapp.com",
        databaseURL: "https://taskmanager-45c3a-default-rtdb.firebaseio.com",
        projectId: "taskmanager-45c3a",
        storageBucket: "taskmanager-45c3a.firebasestorage.app",
        messagingSenderId: "710242454866",
        appId: "1:710242454866:web:a87f396d484014f7c67e8b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentUser = null;
    let globalEmpData = {};
    let currentFilter = 'All';

    function handleLogin() {
        const id = document.getElementById('login-id').value.trim();
        if(id === 'ADMIN00001' || id === 'ASO-1' || id === 'ASO-2') {
            currentUser = { role: 'admin', id: id };
            showDashboard('admin');
        } else {
            db.ref('employees/' + id).once('value', snap => {
                if(snap.exists()) { 
                    currentUser = snap.val(); 
                    showDashboard('employee'); 
                } else { alert("User Code not found!"); }
            });
        }
    }

    function showDashboard(type) {
        document.getElementById('login-section').classList.add('hidden');
        if(type === 'admin') {
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadAdminData();
        } else {
            document.getElementById('employee-dashboard').classList.remove('hidden');
            document.getElementById('display-emp-name').innerText = currentUser.name;
            loadEmployeeTasks();
        }
    }

    function setFilter(status) {
        currentFilter = status;
        loadAdminData();
    }

    function saveEmployee() {
        const n = document.getElementById('reg-name').value;
        const c = document.getElementById('reg-code').value;
        const d = document.getElementById('reg-desig').value;
        const p = document.getElementById('reg-phone').value;
        if(n && c) {
            db.ref('employees/' + c).set({ name: n, code: c, designation: d, phone: p });
            alert("Staff Registered!");
            document.querySelectorAll('#admin-dashboard input').forEach(i => i.value = "");
        }
    }

    function assignTask() {
        const c = document.getElementById('task-assignee').value;
        const t = document.getElementById('task-name').value;
        if(t) {
            db.ref('tasks/' + c).push({ taskName: t, status: 'Initial', date: new Date().toLocaleDateString() });
            alert("Task Assigned!");
            document.getElementById('task-name').value = "";
        }
    }

    function loadAdminData() {
        db.ref('employees').on('value', snap => {
            let opts = "";
            globalEmpData = snap.val() || {}; 
            snap.forEach(e => { opts += `<option value="${e.key}">${e.val().name}</option>`; });
            document.getElementById('task-assignee').innerHTML = opts;
        });

        db.ref('tasks').on('value', snap => {
            let rows = ""; 
            let counts = { Initial: 0, 'In-Process': 0, Completed: 0 };
            
            snap.forEach(empGroup => {
                const staff = globalEmpData[empGroup.key] || { name: "N/A", designation: "N/A", phone: "" };
                empGroup.forEach(tSnap => {
                    const t = tSnap.val();
                    counts[t.status]++;

                    if(currentFilter === 'All' || t.status === currentFilter) {
                        rows += `<tr>
                            <td data-label="Staff Info"><b>${staff.name}</b><br><small>${empGroup.key}</small></td>
                            <td data-label="Designation">${staff.designation || 'N/A'}</td>
                            <td data-label="Task">${t.taskName}</td>
                            <td data-label="Status"><span class="status-tag ${t.status}">${t.status}</span></td>
                            <td data-label="Action">
                                ${staff.phone ? `<a href="tel:${staff.phone}" class="btn-call">ðŸ“ž Call</a>` : ''}
                                <button class="btn-del" onclick="deleteTask('${empGroup.key}','${tSnap.key}')">Del</button>
                            </td>
                        </tr>`;
                    }
                });
            });
            document.getElementById('admin-list').innerHTML = rows || "<tr><td colspan='5' style='text-align:center'>No tasks found.</td></tr>";
            document.getElementById('stat-initial').innerText = counts.Initial;
            document.getElementById('stat-progress').innerText = counts['In-Process'];
            document.getElementById('stat-completed').innerText = counts.Completed;
        });
    }

    function loadEmployeeTasks() {
        db.ref('tasks/' + currentUser.code).on('value', snap => {
            let html = "";
            snap.forEach(tSnap => {
                const t = tSnap.val();
                html += `<div class="card" style="border-left:5px solid var(--accent)">
                    <p><b>Task:</b> ${t.taskName}</p>
                    <select id="sel-${tSnap.key}">
                        <option value="Initial" ${t.status=='Initial'?'selected':''}>Initial</option>
                        <option value="In-Process" ${t.status=='In-Process'?'selected':''}>In-Process</option>
                        <option value="Completed" ${t.status=='Completed'?'selected':''}>Completed</option>
                    </select>
                    <button onclick="updateStatus('${tSnap.key}')" style="background:var(--success)">Update Status</button>
                </div>`;
            });
            document.getElementById('emp-task-cards').innerHTML = html || "No tasks assigned.";
        });
    }

    function updateStatus(tid) {
        const val = document.getElementById('sel-'+tid).value;
        db.ref('tasks/' + currentUser.code + '/' + tid).update({ status: val }).then(() => alert("Updated!"));
    }

    function deleteTask(eid, tid) { if(confirm("Delete task?")) db.ref(`tasks/${eid}/${tid}`).remove(); }
    
    function exportCSV() {
        db.ref('tasks').once('value', snap => {
            let csv = "Staff Name,Emp Code,Designation,Phone,Task,Status,Date\n";
            snap.forEach(eg => {
                const staff = globalEmpData[eg.key] || { name: "N/A", designation: "N/A", phone: "N/A" };
                eg.forEach(t => { 
                    const d = t.val();
                    csv += `"${staff.name}","${eg.key}","${staff.designation}","${staff.phone}","${d.taskName}","${d.status}","${d.date}"\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'Detailed_Task_Report.csv';
            link.click();
        });
    }

    function logout() { location.reload(); }
</script>
</body>
</html>
