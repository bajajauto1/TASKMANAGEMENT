<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bajaj Task Management Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { 
            --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; 
            --light: #f8f9fa; --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f;
            --purple: #9b59b6; --gray: #718096; --gold: #f39c12;
        }
        
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; color: #1a202c; }
        .container { max-width: 1300px; margin: auto; }
        .hidden { display: none !important; }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .nav-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-weight: 700; transition: 0.3s; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .stat-box { flex: 1; min-width: 140px; padding: 20px; border-radius: 12px; color: white; text-align: center; cursor: pointer; transition: 0.3s; }
        .stat-box b { font-size: 28px; display: block; margin-top: 5px; }
        .flex-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }

        .admin-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .action-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 1px solid #edf2f7; display: flex; flex-direction: column; }
        .action-header { display: flex; align-items: center; margin-bottom: 20px; gap: 12px; }
        .icon-circle { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }

        .input-group { margin-bottom: 12px; }
        .input-label { font-size: 11px; font-weight: 700; color: var(--gray); margin-bottom: 5px; display: block; text-transform: uppercase; }
        input, select, textarea { padding: 12px; width: 100%; border: 2px solid #edf2f7; border-radius: 8px; box-sizing: border-box; background: #f7fafc; font-size: 14px; }
        
        .btn-grad { padding: 14px; border-radius: 8px; border: none; color: white; font-weight: 700; cursor: pointer; transition: 0.3s; }

        .flow-container { background: #f8fafc; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .flow-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
        .flow-item:last-child { border: none; }
        .flow-item input { width: 18px; height: 18px; cursor: pointer; }

        .table-section { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; color: var(--gray); font-size: 11px; padding: 15px; text-align: left; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        
        .status-tag { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; }
        .Initial { background: #e2e8f0; color: #4a5568; }
        .In-Process { background: #feebc8; color: #92400e; }
        .Completed { background: #c6f6d5; color: #22543d; }

        .step-pill { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #edf2f7; font-size: 9px; margin: 2px; border: 1px solid #cbd5e0; }
        .step-pill.done { background: var(--success); color: white; border-color: var(--success); }
    </style>
</head>
<body>

<div class="container">
    <div id="login-section">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center;">
            <div class="action-card" style="width: 100%; max-width: 400px; border-top: 5px solid var(--accent);">
                <h2 style="text-align:center;">BAJAJ TASK SYSTEM</h2>
                <input type="text" id="login-id" placeholder="Admin or Employee Code">
                <button onclick="handleLogin()" class="btn-grad" style="background: var(--accent); margin-top:15px;">Access Dashboard</button>
            </div>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div class="dashboard-header">
            <h2>Admin Control Panel</h2>
            <button class="btn-grad" onclick="logout()" style="background: var(--danger); padding: 8px 20px;">Logout</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-btn active" id="tab-tasks" onclick="switchAdminTab('tasks')">Task Management</button>
            <button class="nav-btn" id="tab-billing" onclick="switchAdminTab('billing')">Agency Billing Flow</button>
        </div>

        <div id="admin-task-view">
            <div class="flex-row">
                <div class="stat-box" style="background: var(--gray);"><small>INITIAL</small><b id="stat-initial">0</b></div>
                <div class="stat-box" style="background: var(--warning); color:#333;"><small>IN-PROCESS</small><b id="stat-progress">0</b></div>
                <div class="stat-box" style="background: var(--success);"><small>COMPLETED</small><b id="stat-completed">0</b></div>
            </div>

            <div class="admin-actions-grid">
                <div class="action-card">
                    <div class="action-header"><div class="icon-circle" style="background: var(--primary);">+</div><h3>Staff Registration</h3></div>
                    <input type="text" id="reg-name" placeholder="Full Name" style="margin-bottom:8px;">
                    <input type="text" id="reg-code" placeholder="Employee Code" style="margin-bottom:8px;">
                    <input type="text" id="reg-desig" placeholder="Designation" style="margin-bottom:8px;">
                    <input type="tel" id="reg-phone" placeholder="Phone Number">
                    <button onclick="saveEmployee()" class="btn-grad" style="background: var(--primary); margin-top:15px;">Save Staff</button>
                </div>

                <div class="action-card">
                    <div class="action-header"><div class="icon-circle" style="background: var(--purple);">G</div><h3>Group Assignment</h3></div>
                    <input type="text" id="group-name-input" placeholder="Group Name" style="margin-bottom:8px;">
                    <span class="input-label">Leader (Code - Name)</span>
                    <select id="group-leader-select" style="margin-bottom:8px;"></select>
                    <span class="input-label">Members (Hold Ctrl to select)</span>
                    <select id="group-members-select" multiple style="height: 80px; margin-bottom:8px;"></select>
                    <input type="text" id="group-task-name" placeholder="Group Objective">
                    <button onclick="assignGroupTask()" class="btn-grad" style="background: var(--purple); margin-top:15px;">Deploy Group</button>
                </div>

                <div class="action-card">
                    <div class="action-header"><div class="icon-circle" style="background: var(--success);">T</div><h3>Individual Task</h3></div>
                    <select id="task-assignee" style="margin-bottom:8px;"></select>
                    <textarea id="task-name" placeholder="Task Details..." style="height: 80px;"></textarea>
                    <button onclick="assignTask()" class="btn-grad" style="background: var(--success); margin-top:15px;">Assign Task</button>
                </div>
            </div>

            <div class="table-section">
                <h3>Live Task Feed</h3>
                <table>
                    <thead><tr><th>Staff/Group</th><th>Type</th><th>Details</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody id="admin-list"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-billing-view" class="hidden">
            <div class="admin-actions-grid">
                <div class="action-card">
                    <div class="action-header"><div class="icon-circle" style="background: var(--gold);">$</div><h3>New Billing Assignment</h3></div>
                    <span class="input-label">Assign To Employee</span>
                    <select id="bill-assignee" style="margin-bottom:8px;"></select>
                    <span class="input-label">Select Agency</span>
                    <select id="bill-agency">
                        <option>ANSEC</option><option>BAKUL</option><option>SCRUM</option>
                        <option>COMMANDO DOG</option><option>SWIFT SECURITY</option>
                        <option>EXPERT CORP</option><option>DELTA FORCE</option>
                        <option>G4S</option><option>SIS</option><option>TERRIER</option>
                    </select>
                    <button onclick="assignBilling()" class="btn-grad" style="background: var(--gold); margin-top:15px;">Generate Flow</button>
                    <button onclick="resetBilling()" class="btn-grad" style="background: var(--danger); margin-top:10px;">MONTHLY RESET ALL BILLS</button>
                </div>
            </div>
            <div class="table-section">
                <h3>Agency Flow Status</h3>
                <table>
                    <thead><tr><th>Employee</th><th>Agency</th><th>Steps Progress</th><th>Date</th><th>Action</th></tr></thead>
                    <tbody id="admin-billing-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="employee-dashboard" class="hidden">
        <div class="dashboard-header">
            <h2>Dashboard: <span id="display-emp-name"></span></h2>
            <button class="btn-grad" onclick="logout()" style="background: var(--danger); padding: 8px 20px;">Logout</button>
        </div>
        <div class="nav-tabs">
            <button class="nav-btn active" id="emp-tab-tasks" onclick="switchEmpTab('tasks')">General Tasks</button>
            <button class="nav-btn" id="emp-tab-bill" onclick="switchEmpTab('billing')">Billing Checklist</button>
        </div>
        <div id="employee-task-view"><div id="emp-task-cards" class="admin-actions-grid"></div></div>
        <div id="employee-billing-view" class="hidden"><div id="emp-billing-cards" class="admin-actions-grid"></div></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAmQil4nkkdp98pAYCILemHxRTYCAy5nEw",
        authDomain: "taskmanager-45c3a.firebaseapp.com",
        databaseURL: "https://taskmanager-45c3a-default-rtdb.firebaseio.com",
        projectId: "taskmanager-45c3a",
        storageBucket: "taskmanager-45c3a.firebasestorage.app",
        messagingSenderId: "710242454866",
        appId: "1:710242454866:web:a87f396d484014f7c67e8b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = null;
    let globalEmpData = {};
    const flowSteps = ["Approval Note", "PR", "Attendance Verification", "PO", "Billing Verification", "Release"];

    function handleLogin() {
        const id = document.getElementById('login-id').value.trim();
        if(['ADMIN00001', 'ASO-1', 'ASO-2'].includes(id)) {
            currentUser = { role: 'admin', id: id };
            showDashboard('admin');
        } else {
            db.ref('employees/' + id).once('value', snap => {
                if(snap.exists()) { currentUser = snap.val(); showDashboard('employee'); }
                else { alert("User Code Not Found!"); }
            });
        }
    }

    function showDashboard(type) {
        document.getElementById('login-section').classList.add('hidden');
        if(type === 'admin') {
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadAdminData();
            loadBillingAdmin();
        } else {
            document.getElementById('employee-dashboard').classList.remove('hidden');
            document.getElementById('display-emp-name').innerText = `${currentUser.name} (${currentUser.code})`;
            loadEmployeeTasks();
            loadEmployeeBilling();
        }
    }

    function switchAdminTab(view) {
        document.getElementById('admin-task-view').classList.toggle('hidden', view !== 'tasks');
        document.getElementById('admin-billing-view').classList.toggle('hidden', view !== 'billing');
        document.getElementById('tab-tasks').classList.toggle('active', view === 'tasks');
        document.getElementById('tab-billing').classList.toggle('active', view === 'billing');
    }

    function switchEmpTab(view) {
        document.getElementById('employee-task-view').classList.toggle('hidden', view !== 'tasks');
        document.getElementById('employee-billing-view').classList.toggle('hidden', view !== 'billing');
        document.getElementById('emp-tab-tasks').classList.toggle('active', view === 'tasks');
        document.getElementById('emp-tab-bill').classList.toggle('active', view === 'billing');
    }

    // --- ADMIN TASK LOGIC ---
    function saveEmployee() {
        const n = document.getElementById('reg-name').value, c = document.getElementById('reg-code').value;
        const d = document.getElementById('reg-desig').value, p = document.getElementById('reg-phone').value;
        if(n && c) { 
            db.ref('employees/'+c).set({name:n, code:c, designation:d, phone:p})
            .then(() => { alert("Staff Registered Successfully!"); });
        }
    }

    function assignTask() {
        const c = document.getElementById('task-assignee').value, t = document.getElementById('task-name').value;
        if(t) db.ref('tasks/'+c).push({taskName:t, status:'Initial', date:new Date().toLocaleDateString()});
    }

    function assignGroupTask() {
        const gName = document.getElementById('group-name-input').value;
        const leaderCode = document.getElementById('group-leader-select').value;
        const members = Array.from(document.getElementById('group-members-select').selectedOptions).map(o => o.value);
        const task = document.getElementById('group-task-name').value;
        if(gName && task) {
            db.ref('group_tasks').push({
                groupName: gName, 
                leader: leaderCode, 
                leaderName: globalEmpData[leaderCode].name,
                members: members, 
                taskName: task, 
                status: 'Initial'
            });
            alert("Group Task Deployed!");
        }
    }

    // --- BILLING LOGIC ---
    function assignBilling() {
        const c = document.getElementById('bill-assignee').value, agency = document.getElementById('bill-agency').value;
        const flow = {}; flowSteps.forEach(s => flow[s.replace(/ /g,"_")] = false);
        db.ref('agency_billing').push({
            empCode: c, empName: globalEmpData[c].name, agency: agency, flow: flow, date: new Date().toLocaleDateString()
        });
        alert("Billing Flow Started!");
    }

    function loadBillingAdmin() {
        db.ref('agency_billing').on('value', snap => {
            let rows = "";
            snap.forEach(child => {
                const b = child.val();
                let pills = "";
                flowSteps.forEach(s => {
                    const key = s.replace(/ /g,"_");
                    pills += `<span class="step-pill ${b.flow && b.flow[key] ? 'done' : ''}">${s}</span>`;
                });
                rows += `<tr><td>${b.empName} (${b.empCode})</td><td><b>${b.agency}</b></td><td>${pills}</td><td>${b.date}</td>
                <td><button onclick="deleteBill('${child.key}')" style="color:red; border:none; background:none; cursor:pointer;">Delete</button></td></tr>`;
            });
            document.getElementById('admin-billing-list').innerHTML = rows;
        });
    }

    function updateBillStep(id, key, val) { db.ref(`agency_billing/${id}/flow/${key}`).set(val); }
    function deleteBill(id) { if(confirm("Delete this billing flow?")) db.ref('agency_billing/'+id).remove(); }
    function resetBilling() { if(confirm("Reset ALL billing for the new month?")) db.ref('agency_billing').remove(); }

    // --- DATA REFRESH ---
    function loadAdminData() {
        db.ref('employees').on('value', snap => {
            let opts = ""; globalEmpData = snap.val() || {};
            snap.forEach(e => { opts += `<option value="${e.key}">${e.key} - ${e.val().name}</option>`; });
            document.getElementById('task-assignee').innerHTML = opts;
            document.getElementById('group-leader-select').innerHTML = opts;
            document.getElementById('group-members-select').innerHTML = opts;
            document.getElementById('bill-assignee').innerHTML = opts;
        });

        db.ref().on('value', snap => {
            let rows = "", counts = {Initial:0, 'In-Process':0, Completed:0};
            const tasks = snap.child('tasks').val() || {}, groups = snap.child('group_tasks').val() || {};

            Object.keys(tasks).forEach(code => {
                Object.keys(tasks[code]).forEach(k => {
                    const t = tasks[code][k]; counts[t.status]++;
                    rows += `<tr><td>${globalEmpData[code]?.name || code}</td><td>Individual</td><td>${t.taskName}</td><td><span class="status-tag ${t.status}">${t.status}</span></td><td><button onclick="deleteTask('${code}','${k}','single')">X</button></td></tr>`;
                });
            });
            Object.keys(groups).forEach(k => {
                const g = groups[k]; counts[g.status]++;
                rows += `<tr style="background:#f9f5ff"><td><b>${g.groupName}</b> (Ldr: ${g.leaderName})</td><td>Group</td><td>${g.taskName}</td><td><span class="status-tag ${g.status}">${g.status}</span></td><td><button onclick="deleteTask(null,'${k}','group')">X</button></td></tr>`;
            });
            document.getElementById('admin-list').innerHTML = rows;
            document.getElementById('stat-initial').innerText = counts.Initial;
            document.getElementById('stat-progress').innerText = counts['In-Process'];
            document.getElementById('stat-completed').innerText = counts.Completed;
        });
    }

    // --- EMPLOYEE DASHBOARD LOGIC (SOLVED: ADDED GROUP TASKS) ---
    function loadEmployeeTasks() {
        db.ref().on('value', snap => {
            let html = "";
            
            // 1. Load Individual Tasks
            const individualTasks = snap.child('tasks/'+currentUser.code).val() || {};
            Object.keys(individualTasks).forEach(k => {
                const t = individualTasks[k];
                html += `<div class="action-card" style="border-top: 5px solid var(--success);">
                <small style="color:var(--gray)">INDIVIDUAL TASK</small>
                <h3>${t.taskName}</h3>
                <select id="s-${k}" style="margin-bottom:10px;">
                    <option value="Initial" ${t.status==='Initial'?'selected':''}>Initial</option>
                    <option value="In-Process" ${t.status==='In-Process'?'selected':''}>In-Process</option>
                    <option value="Completed" ${t.status==='Completed'?'selected':''}>Completed</option>
                </select>
                <button onclick="updateStatus('${k}','single')" class="btn-grad" style="background:var(--accent); padding:8px;">Update Status</button></div>`;
            });

            // 2. Load Group Tasks (where user is Leader or Member)
            const groupTasks = snap.child('group_tasks').val() || {};
            Object.keys(groupTasks).forEach(gk => {
                const g = groupTasks[gk];
                const isMember = g.members && g.members.includes(currentUser.code);
                const isLeader = g.leader === currentUser.code;
                
                if(isLeader || isMember) {
                    html += `<div class="action-card" style="border-top: 5px solid var(--purple); background: #fdfaff;">
                    <small style="color:var(--purple); font-weight:bold;">GROUP: ${g.groupName} ${isLeader ? '(LEADER)' : '(MEMBER)'}</small>
                    <h3>${g.taskName}</h3>
                    <select id="s-${gk}" style="margin-bottom:10px;">
                        <option value="Initial" ${g.status==='Initial'?'selected':''}>Initial</option>
                        <option value="In-Process" ${g.status==='In-Process'?'selected':''}>In-Process</option>
                        <option value="Completed" ${g.status==='Completed'?'selected':''}>Completed</option>
                    </select>
                    <button onclick="updateStatus('${gk}','group')" class="btn-grad" style="background:var(--purple); padding:8px;">Update Group Status</button></div>`;
                }
            });

            document.getElementById('emp-task-cards').innerHTML = html || "<p>No individual or group tasks assigned.</p>";
        });
    }

    function loadEmployeeBilling() {
        db.ref('agency_billing').on('value', snap => {
            let html = "";
            snap.forEach(child => {
                const b = child.val();
                if(b.empCode === currentUser.code) {
                    let checklist = "";
                    flowSteps.forEach(s => {
                        const key = s.replace(/ /g,"_");
                        const checked = b.flow && b.flow[key] ? 'checked' : '';
                        checklist += `<div class="flow-item"><input type="checkbox" ${checked} onchange="updateBillStep('${child.key}','${key}',this.checked)"> <label>${s}</label></div>`;
                    });
                    html += `<div class="action-card" style="border-left: 10px solid var(--gold)"><h3>${b.agency} Flow</h3><div class="flow-container">${checklist}</div></div>`;
                }
            });
            document.getElementById('emp-billing-cards').innerHTML = html || "<p>No agency billing flow assigned to you.</p>";
        });
    }

    function updateStatus(id, type) {
        const val = document.getElementById('s-'+id).value;
        const path = type === 'single' ? `tasks/${currentUser.code}/${id}` : `group_tasks/${id}`;
        db.ref(path).update({status:val}); alert("Task Status Updated!");
    }

    function deleteTask(code, k, type) { if(confirm("Delete Task?")) db.ref(type==='single' ? `tasks/${code}/${k}` : `group_tasks/${k}`).remove(); }
    function logout() { location.reload(); }
</script>
</body>
</html>
